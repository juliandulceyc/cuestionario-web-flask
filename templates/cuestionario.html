<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Evaluaci√≥n - {{ candidato.nombre_completo }}</title>
    <style>
        body { font-family: Arial, sans-serif; background: #f5f5f5; margin: 0; padding: 20px; }
        .container { max-width: 800px; margin: 0 auto; background: white; padding: 30px; border-radius: 10px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
        .header { text-align: center; margin-bottom: 30px; }
        .info { background: #e3f2fd; padding: 15px; border-radius: 8px; margin-bottom: 20px; }
        .candidate-form-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }
        .candidate-form-grid input { padding: 12px; border: 1px solid #ddd; border-radius: 6px; }
        .pregunta { background: #f8f9fa; padding: 20px; border-radius: 8px; margin-bottom: 20px; }
        .opcion { display: block; margin: 10px 0; padding: 15px; background: #e9ecef; border: 2px solid transparent; border-radius: 8px; cursor: pointer; transition: all 0.3s; }
        .opcion:hover { background: #dee2e6; border-color: #007bff; }
        .opcion.seleccionada { background-color: #007bff !important; color: white !important; border-color: #0056b3 !important; }
        button { background: #28a745; color: white; padding: 12px 24px; border: none; border-radius: 6px; cursor: pointer; font-size: 16px; margin: 5px; }
        button:hover { background: #218838; }
        button:disabled { background: #6c757d; cursor: not-allowed; }
        #mensaje { margin-top: 20px; padding: 15px; border-radius: 8px; }
        .progreso { background: #e9ecef; height: 10px; border-radius: 5px; margin-bottom: 20px; }
        .progreso-barra { background: #007bff; height: 100%; border-radius: 5px; transition: width 0.3s; }
        
        /* Remover cualquier indicador visual de correcto/incorrecto */
        .opcion.correcta,
        .opcion.incorrecta {
            background-color: #f8f9fa !important;
            color: #6c757d !important;
        }
        
        /* Opci√≥n deshabilitada despu√©s de responder */
        .opcion:disabled,
        .opcion[style*="pointer-events: none"] {
            background-color: #f8f9fa !important;
            color: #6c757d !important;
            border-color: #dee2e6 !important;
        }

        /* ‚úÖ ESTILOS PARA CONFIGURACI√ìN AUTOM√ÅTICA */
        .config-info {
            background: #d4edda;
            color: #155724;
            padding: 10px;
            border-radius: 5px;
            margin-bottom: 15px;
            border: 1px solid #c3e6cb;
            font-size: 14px;
        }

        /* ‚úÖ ESTILOS PARA PROGRESO DIN√ÅMICO */
        .progreso-texto {
            text-align: center;
            margin-bottom: 10px;
            font-weight: bold;
            color: #495057;
        }

        /* ‚úÖ ESTILOS PARA NIVEL DEL CANDIDATO */
        .nivel-badge {
            display: inline-block;
            background: #6f42c1;
            color: white;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: bold;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>Prueba T√©cnica</h1>
            <!-- ‚úÖ INFORMACI√ìN DE CONFIGURACI√ìN AUTOM√ÅTICA -->
            <div id="config-display" class="config-info" style="display: none;">
                üìä Evaluaci√≥n de <span class="total-preguntas">5</span> preguntas | 
                üéØ Avance autom√°tico por niveles | 
                ‚è±Ô∏è Sin l√≠mite de tiempo
            </div>
        </div>
        
        <!-- INFORMACI√ìN DEL CANDIDATO (AUTO-LLENADO) -->
        <div class="info" id="info-candidato">
            <strong>üë§ Candidato:</strong> {{ candidato.nombre_completo }}<br>
            <strong>üìß Email:</strong> {{ candidato.email }}<br>
            <strong>üîë C√≥digo:</strong> {{ candidato.codigo }}
        </div>
        
        <!-- FORMULARIO DE CONFIRMACI√ìN -->
        <div id="formulario-confirmacion">
            <div class="candidate-form-grid">
                <input type="text" id="nombre_completo" value="{{ candidato.nombre_completo }}" placeholder="Nombre completo" required>
                <input type="hidden" id="documento" value="{{ candidato.codigo }}">
                <input type="email" id="email" value="{{ candidato.email }}" placeholder="Email" required>
                <input type="tel" id="telefono" value="{{ candidato.telefono or '' }}" placeholder="Tel√©fono">
            </div>
            <button onclick="iniciarEvaluacion()" style="width: 100%; margin-top: 15px;">üöÄ Confirmar Datos e Iniciar Evaluaci√≥n</button>
        </div>
        
        <!-- ‚úÖ PROGRESO AUTOM√ÅTICO -->
        <div id="progreso-container" style="display: none;">
            <div class="progreso-texto" id="progreso-texto">Pregunta 1 de 5</div>
            <div class="progreso">
                <div class="progreso-barra" id="barraProgreso" style="width: 0%" aria-valuemax="5"></div>
            </div>
        </div>
        
        <!-- CONTENEDOR DE PREGUNTAS -->
        <div id="pregunta-container" style="display: none;">
            <div class="pregunta">
                <h3 id="pregunta-texto">Cargando pregunta...</h3>
            </div>
            <div id="opciones-container"></div>
            
            <!-- BOTONES DE ACCI√ìN - SIMPLIFICADO -->
            <div style="text-align: center; margin-top: 30px;">
                <button id="btn-responder" onclick="responder()" disabled 
                        style="background: #007bff; color: white; padding: 12px 30px; border: none; border-radius: 5px; font-size: 16px; cursor: pointer; transition: all 0.3s;">
                    Responder
                </button>
            </div>
        </div>
        
        <!-- MENSAJES -->
        <div id="mensaje" style="display: none;"></div>
    </div>

    <script>
        // ‚úÖ VARIABLES GLOBALES PARA CONFIGURACI√ìN AUTOM√ÅTICA
        let respuestasSeleccionadas = [];
        let preguntaActual = null;
        let CONFIGURACION_EVALUACION = null;

        // ‚úÖ OBTENER CONFIGURACI√ìN AUTOM√ÅTICA DEL BACKEND
        async function obtenerConfiguracion() {
            try {
                const response = await fetch('/api/configuracion');
                CONFIGURACION_EVALUACION = await response.json();
                console.log('üîß Configuraci√≥n cargada:', CONFIGURACION_EVALUACION);
                
                // Actualizar elementos del DOM autom√°ticamente
                actualizarElementosConfiguracion();
                
                return true;
            } catch (error) {
                console.error('Error obteniendo configuraci√≥n:', error);
                // Fallback si no puede conectar
                CONFIGURACION_EVALUACION = {
                    total_preguntas: 5,
                    preguntas_nivel_1: 3,
                    min_correctas_avance: 2,
                    niveles_maximos: 5
                };
                actualizarElementosConfiguracion();
                return false;
            }
        }

        // ‚úÖ ACTUALIZAR ELEMENTOS DEL DOM CON CONFIGURACI√ìN AUTOM√ÅTICA
        function actualizarElementosConfiguracion() {
            if (!CONFIGURACION_EVALUACION) return;

            // Actualizar total de preguntas en todos los elementos
            const totalElements = document.querySelectorAll('.total-preguntas');
            totalElements.forEach(el => {
                el.textContent = CONFIGURACION_EVALUACION.total_preguntas;
            });
            
            // Actualizar barra de progreso m√°xima
            const progressBar = document.querySelector('#barraProgreso');
            if (progressBar) {
                progressBar.setAttribute('aria-valuemax', CONFIGURACION_EVALUACION.total_preguntas);
            }

            // Mostrar informaci√≥n de configuraci√≥n
            const configDisplay = document.getElementById('config-display');
            if (configDisplay) {
                configDisplay.style.display = 'block';
            }

            console.log(`‚úÖ DOM actualizado para ${CONFIGURACION_EVALUACION.total_preguntas} preguntas`);
        }

        // ‚úÖ INICIALIZAR AL CARGAR LA P√ÅGINA
        document.addEventListener('DOMContentLoaded', async function() {
            console.log('üîÑ Inicializando sistema de evaluaci√≥n...');
            await obtenerConfiguracion();
        });

        function iniciarEvaluacion() {
            const nombre = document.getElementById('nombre_completo').value.trim();
            const documento = document.getElementById('documento').value.trim();
            const email = document.getElementById('email').value.trim();
            const telefono = document.getElementById('telefono').value.trim();

            if (!nombre || !email) {
                alert('Completa todos los campos obligatorios');
                return;
            }

            fetch('/iniciar_evaluacion', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    nombre: nombre,
                    documento: documento,
                    email: email,
                    telefono: telefono
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.mensaje) {
                    document.getElementById('formulario-confirmacion').style.display = 'none';
                    document.getElementById('progreso-container').style.display = 'block';
                    document.getElementById('pregunta-container').style.display = 'block';
                    
                    console.log('‚úÖ Evaluaci√≥n iniciada correctamente');
                    cargarPregunta();
                } else {
                    alert('Error: ' + data.error);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Error iniciando evaluaci√≥n');
            });
        }

        function cargarPregunta() {
            fetch('/obtener_pregunta')
            .then(response => response.json())
            .then(data => {
                if (data.error) {
                    console.log('üìù Evaluaci√≥n completada - ' + data.error);
                    mostrarEvaluacionCompleta();
                } else {
                    mostrarPregunta(data);
                }
            })
            .catch(error => {
                console.error('Error cargando pregunta:', error);
                alert('Error cargando pregunta. Intenta recargar la p√°gina.');
            });
        }

        function mostrarPregunta(data) {
            preguntaActual = data;
            respuestasSeleccionadas = [];
            
            console.log(`üìù Mostrando pregunta ${data.pregunta_numero}/${data.total_preguntas} - Nivel ${data.nivel_candidato}`);
            
            // ‚úÖ ACTUALIZAR PROGRESO AUTOM√ÅTICO
            const progreso = (data.pregunta_numero / data.total_preguntas) * 100;
            document.getElementById('barraProgreso').style.width = progreso + '%';
            
            // ‚úÖ ACTUALIZAR TEXTO DE PROGRESO DIN√ÅMICO
            document.getElementById('progreso-texto').textContent = 
                `Pregunta ${data.pregunta_numero} de ${data.total_preguntas}`;
            
            // Determinar tipo de pregunta
            const esMultiple = data.multiple || false;
            const tipoInfo = esMultiple ? 
                '<div style="background: #fff3cd; color: #856404; padding: 10px; border-radius: 5px; margin-bottom: 15px; border: 1px solid #ffeaa7;"><strong>üî¢ PREGUNTA DE RESPUESTA M√öLTIPLE</strong><br>Puedes seleccionar hasta 2 respuestas correctas</div>' :
                '<div style="background: #d1ecf1; color: #0c5460; padding: 10px; border-radius: 5px; margin-bottom: 15px; border: 1px solid #b8daff;"><strong>üìù PREGUNTA DE RESPUESTA √öNICA</strong><br>Selecciona la respuesta correcta</div>';
            
            // ‚úÖ CREAR CONTENIDO DE IMAGEN DESDE EL EXCEL
            let imagenHtml = '';
            if (data.imagen && data.imagen.trim() !== '') {
                imagenHtml = `
                    <div style="text-align: center; margin: 15px 0;">
                        <img src="${data.imagen}" 
                             alt="Imagen de la pregunta" 
                             style="max-width: 100%; max-height: 400px; border: 1px solid #ddd; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);"
                             onerror="this.style.display='none'; document.getElementById('error-imagen-${data.id}').style.display='block';">
                        <div id="error-imagen-${data.id}" style="display: none; color: #dc3545; font-size: 14px; margin-top: 10px;">
                            ‚ö†Ô∏è No se pudo cargar la imagen
                        </div>
                    </div>
                `;
            }
            
            // ‚úÖ MOSTRAR PREGUNTA CON INFORMACI√ìN DE NIVEL
            document.getElementById('pregunta-texto').innerHTML = `
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                    <strong>Pregunta ${data.pregunta_numero} de ${data.total_preguntas}</strong>
                    <div>
                        <span class="nivel-badge">Nivel Pregunta: ${data.nivel_pregunta || 1}</span>
                        <span class="nivel-badge" style="background: #28a745; margin-left: 5px;">Tu Nivel: ${data.nivel_candidato || 1}</span>
                    </div>
                </div>
                ${tipoInfo}
                ${data.pregunta}
                ${imagenHtml}
            `;
            
            // Mostrar opciones
            const container = document.getElementById('opciones-container');
            container.innerHTML = '';
            
            data.opciones.forEach((opcion, index) => {
                const div = document.createElement('div');
                div.className = 'opcion';
                div.innerHTML = `${String.fromCharCode(65 + index)}. ${opcion}`;
                div.onclick = () => seleccionarOpcion(index, div, esMultiple, opcion);
                container.appendChild(div);
            });
            
            // Resetear botones
            document.getElementById('btn-responder').disabled = true;
            document.getElementById('btn-responder').style.display = 'inline-block';
        }

        function seleccionarOpcion(index, elemento, esMultiple, textoOpcion) {
            const letra = String.fromCharCode(65 + index); // A, B, C, D
            
            if (esMultiple) {
                // PREGUNTA M√öLTIPLE - Permitir hasta 2 selecciones
                if (elemento.classList.contains('seleccionada')) {
                    // Deseleccionar
                    elemento.classList.remove('seleccionada');
                    respuestasSeleccionadas = respuestasSeleccionadas.filter(r => r !== textoOpcion);
                } else {
                    // Seleccionar (m√°ximo 2)
                    if (respuestasSeleccionadas.length < 2) {
                        elemento.classList.add('seleccionada');
                        respuestasSeleccionadas.push(textoOpcion);
                    } else {
                        alert('M√°ximo 2 respuestas permitidas para esta pregunta');
                        return;
                    }
                }
            } else {
                // PREGUNTA √öNICA - Solo una selecci√≥n
                document.querySelectorAll('.opcion').forEach(op => op.classList.remove('seleccionada'));
                elemento.classList.add('seleccionada');
                respuestasSeleccionadas = [textoOpcion]; // ‚úÖ USAR TEXTO DE LA OPCI√ìN, NO LETRA
            }
            
            // Habilitar bot√≥n si hay al menos una selecci√≥n
            document.getElementById('btn-responder').disabled = respuestasSeleccionadas.length === 0;
            
            console.log(`üéØ Seleccionada: ${textoOpcion} | Total seleccionadas: ${respuestasSeleccionadas.length}`);
        }

        function responder() {
            if (respuestasSeleccionadas.length === 0 || !preguntaActual) {
                alert('Selecciona al menos una respuesta');
                return;
            }

            // Deshabilitar bot√≥n para evitar doble clic
            document.getElementById('btn-responder').disabled = true;
            document.getElementById('btn-responder').innerHTML = 'Guardando...';

            // ‚úÖ ENVIAR RESPUESTAS - TEXTO COMPLETO DE LA OPCI√ìN
            const respuestaEnviar = respuestasSeleccionadas.join(',');

            console.log(`üì§ Enviando respuesta: "${respuestaEnviar}" para pregunta ${preguntaActual.id}`);

            fetch('/responder', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    respuesta: respuestaEnviar,
                    pregunta_id: preguntaActual.id,
                    respuestas_seleccionadas: respuestasSeleccionadas
                })
            })
            .then(response => response.json())
            .then(data => {
                console.log('üì• Respuesta del servidor:', data);
                
                if (data.success) {
                    // Mostrar feedback de nivel si hubo cambio
                    if (data.avanzar_nivel) {
                        mostrarMensajeNivelUp(data.nivel);
                    }
                    
                    // Mostrar mensaje de guardado brevemente
                    mostrarMensajeGuardadoRapido();
                    
                    // Esperar 1.5 segundos y continuar autom√°ticamente
                    setTimeout(() => {
                        if (data.hay_mas) {
                            // Cargar siguiente pregunta directamente
                            siguientePregunta();
                        } else {
                            // ‚úÖ EVALUACI√ìN TERMINADA - GENERAR PDF AUTOM√ÅTICAMENTE
                            console.log('üéâ Evaluaci√≥n completada - Generando PDF...');
                            generarPDFAutomatico();
                        }
                    }, 1500);
                } else {
                    alert('Error: ' + (data.error || 'Error desconocido'));
                    rehabilitarBotonResponder();
                }
            })
            .catch(error => {
                console.error('Error enviando respuesta:', error);
                alert('Error enviando respuesta, intenta nuevamente');
                rehabilitarBotonResponder();
            });
        }

        // ‚úÖ MOSTRAR MENSAJE DE LEVEL UP
        function mostrarMensajeNivelUp(nuevoNivel) {
            const mensaje = document.createElement('div');
            mensaje.style.cssText = `
                position: fixed;
                top: 50%;
                left: 50%;
                transform: translate(-50%, -50%);
                background: linear-gradient(45deg, #28a745, #20c997);
                color: white;
                padding: 20px 30px;
                border-radius: 10px;
                font-size: 18px;
                font-weight: bold;
                z-index: 1000;
                box-shadow: 0 4px 15px rgba(0,0,0,0.3);
                text-align: center;
            `;
            mensaje.innerHTML = `üéâ ¬°NIVEL UP!<br>Has avanzado al Nivel ${nuevoNivel}`;
            
            document.body.appendChild(mensaje);
            
            // Remover despu√©s de 2 segundos
            setTimeout(() => {
                if (mensaje.parentNode) {
                    mensaje.parentNode.removeChild(mensaje);
                }
            }, 2000);
        }

        function mostrarMensajeGuardadoRapido() {
            // Deshabilitar opciones y mostrar mensaje
            document.querySelectorAll('.opcion').forEach(op => {
                op.style.pointerEvents = 'none';
                op.style.opacity = '0.7';
            });
            
            // Cambiar texto del bot√≥n
            document.getElementById('btn-responder').innerHTML = '‚úÖ Guardado';
            document.getElementById('btn-responder').style.backgroundColor = '#28a745';
        }

        function rehabilitarBotonResponder() {
            document.getElementById('btn-responder').disabled = false;
            document.getElementById('btn-responder').innerHTML = 'Responder';
            document.getElementById('btn-responder').style.backgroundColor = '#007bff';
        }

        function siguientePregunta() {
            // Rehabilitar opciones para la nueva pregunta
            document.querySelectorAll('.opcion').forEach(op => {
                op.style.pointerEvents = 'auto';
                op.style.opacity = '1';
                op.classList.remove('seleccionada');
            });
            
            // Resetear bot√≥n responder
            document.getElementById('btn-responder').disabled = true;
            document.getElementById('btn-responder').innerHTML = 'Responder';
            document.getElementById('btn-responder').style.backgroundColor = '#007bff';
            
            // Limpiar respuestas seleccionadas
            respuestasSeleccionadas = [];
            
            // Cargar siguiente pregunta
            cargarPregunta();
        }

        // ‚úÖ GENERAR PDF AUTOM√ÅTICAMENTE AL COMPLETAR
        function generarPDFAutomatico() {
            console.log('üìÑ Iniciando generaci√≥n autom√°tica de PDF...');
            
            fetch('/generar_pdf_final', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                }
            })
            .then(response => response.json())
            .then(data => {
                console.log('üìÑ Respuesta PDF:', data);
                
                if (data.success) {
                    mostrarEvaluacionCompleta(data);
                } else {
                    console.error('Error generando PDF:', data.error);
                    mostrarEvaluacionCompleta(null, 'Error generando reporte: ' + data.error);
                }
            })
            .catch(error => {
                console.error('Error generando PDF:', error);
                mostrarEvaluacionCompleta(null, 'Error de conexi√≥n generando reporte');
            });
        }

        function mostrarEvaluacionCompleta(datosResultado = null, errorPDF = null) {
            document.getElementById('pregunta-container').style.display = 'none';
            document.getElementById('barraProgreso').style.width = '100%';
            document.getElementById('progreso-texto').textContent = '¬°Evaluaci√≥n Completada!';
            
            let mensajeResultados = '';
            let mensajePDF = '';
            
            if (datosResultado && datosResultado.success) {
                mensajeResultados = `
                    <div style="background: #d4edda; color: #155724; padding: 15px; border-radius: 8px; margin-bottom: 15px;">
                        <h4>üìä Resultados de tu Evaluaci√≥n:</h4>
                        <ul style="margin: 10px 0; padding-left: 20px;">
                            <li><strong>Respuestas correctas:</strong> ${datosResultado.correctas}/${datosResultado.total} (${datosResultado.porcentaje}%)</li>
                            <li><strong>Nivel final alcanzado:</strong> ${datosResultado.nivel_final}/5</li>
                            <li><strong>Puntuaci√≥n total:</strong> ${datosResultado.puntos} puntos</li>
                        </ul>
                    </div>
                `;
                
                mensajePDF = datosResultado.pdf_generado ? 
                    '<div style="background: #cce5ff; color: #004085; padding: 10px; border-radius: 5px;">‚úÖ Reporte PDF generado correctamente</div>' :
                    '<div style="background: #fff3cd; color: #856404; padding: 10px; border-radius: 5px;">‚ö†Ô∏è Evaluaci√≥n guardada, reporte en proceso</div>';
            }
            
            if (errorPDF) {
                mensajePDF = `<div style="background: #f8d7da; color: #721c24; padding: 10px; border-radius: 5px;">‚ö†Ô∏è ${errorPDF}</div>`;
            }
            
            document.getElementById('mensaje').innerHTML = `
                <div style="text-align: center;">
                    <div style="background: #d4edda; color: #155724; padding: 30px; border-radius: 10px; border: 1px solid #c3e6cb; margin-bottom: 20px;">
                        <h2>üéâ ¬°Evaluaci√≥n Completada!</h2>
                        <p>Todas tus respuestas han sido guardadas correctamente.</p>
                        ${mensajeResultados}
                        ${mensajePDF}
                        <div style="margin-top: 20px;">
                            <p><strong>Los resultados ser√°n enviados a Recursos Humanos.</strong></p>
                            <small style="color: #6c757d;">Puedes cerrar esta ventana de forma segura.</small>
                        </div>
                    </div>
                </div>
            `;
            document.getElementById('mensaje').style.display = 'block';
            
            console.log('‚úÖ Evaluaci√≥n completada exitosamente');
        }
    </script>
</body>
</html>